<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reddit RSS Collector</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: {
              bg: '#0f172a',
              card: '#1e293b',
              border: '#334155',
              text: '#e2e8f0',
              muted: '#94a3b8'
            }
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0f172a; }
  </style>
</head>
<body class="bg-dark-bg min-h-screen text-dark-text">
  <div id="app" class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-white">Opportunity Radar ðŸ“¡</h1>
      <p class="text-dark-muted">Finding the problems worth solving so you don't have to doomscroll</p>
    </header>

    <!-- Navigation Tabs -->
    <div class="mb-6 border-b border-dark-border">
      <nav class="flex space-x-4">
        <button onclick="showView('posts')" id="tab-posts" class="tab-btn px-4 py-2 font-medium text-blue-400 border-b-2 border-blue-400">Posts</button>
        <button onclick="showView('niches')" id="tab-niches" class="tab-btn px-4 py-2 font-medium text-dark-muted hover:text-white">Niches</button>
        <button onclick="showView('subreddits')" id="tab-subreddits" class="tab-btn px-4 py-2 font-medium text-dark-muted hover:text-white">Subreddits</button>
      </nav>
    </div>

    <!-- Posts View -->
    <div id="view-posts">
      <!-- Filters -->
      <div class="bg-dark-card rounded-lg shadow-lg p-4 mb-6 border border-dark-border">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-dark-muted mb-1">Search</label>
            <input type="text" id="filter-search" placeholder="Search title/body..." 
              class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-md text-white placeholder-dark-muted focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-dark-muted mb-1">Subreddit</label>
            <select id="filter-subreddit" class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">All Subreddits</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-dark-muted mb-1">Min Upvotes: <span id="min-upvotes-value">0</span></label>
            <input type="range" id="filter-min-upvotes" min="0" max="100" value="0" class="w-full accent-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-dark-muted mb-1">Min Triage: <span id="min-triage-value">0</span></label>
            <input type="range" id="filter-min-triage" min="0" max="10" value="0" class="w-full accent-blue-500">
          </div>
        </div>
        
        <!-- Evaluation Filters -->
        <div class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-4 p-3 bg-dark-bg rounded-lg border border-dark-border">
          <div class="col-span-2 md:col-span-5 text-xs font-medium text-purple-400 uppercase tracking-wide">Glitch's Evaluation Filters</div>
          <div>
            <label class="block text-xs text-dark-muted mb-1">Min Total: <span id="min-total-value">0</span></label>
            <input type="range" id="filter-min-total" min="0" max="40" value="0" class="w-full accent-purple-500">
          </div>
          <div>
            <label class="block text-xs text-dark-muted mb-1">Min Market: <span id="min-market-value">0</span></label>
            <input type="range" id="filter-min-market" min="0" max="10" value="0" class="w-full accent-purple-500">
          </div>
          <div>
            <label class="block text-xs text-dark-muted mb-1">Min WTP: <span id="min-wtp-value">0</span></label>
            <input type="range" id="filter-min-wtp" min="0" max="10" value="0" class="w-full accent-purple-500">
          </div>
          <div>
            <label class="block text-xs text-dark-muted mb-1">Min Ease: <span id="min-ease-value">0</span></label>
            <input type="range" id="filter-min-ease" min="0" max="10" value="0" class="w-full accent-purple-500">
          </div>
          <div>
            <label class="block text-xs text-dark-muted mb-1">Min Competition: <span id="min-comp-value">0</span></label>
            <input type="range" id="filter-min-comp" min="0" max="10" value="0" class="w-full accent-purple-500">
          </div>
        </div>
        
        <div class="mt-4 flex flex-wrap items-center gap-4">
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="filter-bookmarked" class="w-4 h-4 rounded bg-dark-bg border-dark-border text-yellow-500 focus:ring-yellow-500">
            <span class="text-sm text-dark-muted">Bookmarked only</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="filter-passed" class="w-4 h-4 rounded bg-dark-bg border-dark-border text-green-500 focus:ring-green-500">
            <span class="text-sm text-dark-muted">Passed triage only</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="filter-evaluated" class="w-4 h-4 rounded bg-dark-bg border-dark-border text-purple-500 focus:ring-purple-500">
            <span class="text-sm text-dark-muted">Evaluated only</span>
          </label>
          
          <div class="flex-1"></div>
          
          <button onclick="resetFilters()" class="px-3 py-1.5 text-sm text-dark-muted hover:text-white border border-dark-border rounded-md hover:bg-dark-border">Reset Filters</button>
          
          <span id="filter-status" class="text-sm text-dark-muted"></span>
          
          <button onclick="triggerTriage()" id="triage-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 text-sm">Triage Now</button>
          <button onclick="stopTriage()" id="stop-triage-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm hidden">Stop Triage</button>
          <button onclick="triggerCollect()" id="collect-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">Collect Now</button>
        </div>
      </div>

      <!-- Posts List -->
      <div id="posts-container" class="space-y-3">
        <p class="text-dark-muted text-center py-8">Loading posts...</p>
      </div>

      <!-- Pagination -->
      <div id="pagination" class="mt-6 flex justify-center items-center space-x-4 hidden">
        <button onclick="prevPage()" id="prev-btn" class="px-4 py-2 bg-dark-card border border-dark-border text-dark-text rounded-md hover:bg-dark-border disabled:opacity-50">Previous</button>
        <span id="page-info" class="text-dark-muted"></span>
        <button onclick="nextPage()" id="next-btn" class="px-4 py-2 bg-dark-card border border-dark-border text-dark-text rounded-md hover:bg-dark-border disabled:opacity-50">Next</button>
      </div>
    </div>

    <!-- Niches View -->
    <div id="view-niches" class="hidden">
      <!-- Niche Filters -->
      <div class="bg-dark-card rounded-lg shadow-lg p-4 mb-6 border border-dark-border">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-dark-muted mb-1">Search</label>
            <input type="text" id="niche-filter-search" placeholder="Search niches..." 
              class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-md text-white placeholder-dark-muted focus:outline-none focus:ring-2 focus:ring-purple-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-dark-muted mb-1">Min Total: <span id="niche-min-total-value">0</span></label>
            <input type="range" id="niche-filter-min-total" min="0" max="40" value="0" class="w-full accent-purple-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-dark-muted mb-1">Min Revenue: <span id="niche-min-revenue-value">0</span></label>
            <input type="range" id="niche-filter-min-revenue" min="0" max="10" value="0" class="w-full accent-green-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-dark-muted mb-1">Min Defensibility: <span id="niche-min-def-value">0</span></label>
            <input type="range" id="niche-filter-min-def" min="0" max="10" value="0" class="w-full accent-blue-500">
          </div>
        </div>
        <div class="mt-4 flex items-center gap-4">
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="niche-filter-evaluated" class="w-4 h-4 rounded bg-dark-bg border-dark-border text-purple-500 focus:ring-purple-500">
            <span class="text-sm text-dark-muted">Evaluated only</span>
          </label>
          <button onclick="resetNicheFilters()" class="px-3 py-1.5 text-sm text-dark-muted hover:text-white border border-dark-border rounded-md hover:bg-dark-border">Reset Filters</button>
        </div>
      </div>

      <!-- Niches Table -->
      <div class="bg-dark-card rounded-lg border border-dark-border overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="bg-dark-bg border-b border-dark-border">
              <tr>
                <th class="px-4 py-3 text-dark-muted font-medium">Description</th>
                <th class="px-4 py-3 text-dark-muted font-medium">Parent Opportunity</th>
                <th class="px-4 py-3 text-dark-muted font-medium text-center">Revenue</th>
                <th class="px-4 py-3 text-dark-muted font-medium text-center">Defensibility</th>
                <th class="px-4 py-3 text-dark-muted font-medium text-center">Total</th>
                <th class="px-4 py-3 text-dark-muted font-medium">Source</th>
              </tr>
            </thead>
            <tbody id="niches-table-body">
              <tr><td colspan="6" class="px-4 py-8 text-center text-dark-muted">Loading niches...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Niche Pagination -->
      <div id="niche-pagination" class="mt-6 flex justify-center items-center space-x-4 hidden">
        <button onclick="prevNichePage()" id="niche-prev-btn" class="px-4 py-2 bg-dark-card border border-dark-border text-dark-text rounded-md hover:bg-dark-border disabled:opacity-50">Previous</button>
        <span id="niche-page-info" class="text-dark-muted"></span>
        <button onclick="nextNichePage()" id="niche-next-btn" class="px-4 py-2 bg-dark-card border border-dark-border text-dark-text rounded-md hover:bg-dark-border disabled:opacity-50">Next</button>
      </div>
    </div>

    <!-- Subreddits View -->
    <div id="view-subreddits" class="hidden">
      <div class="bg-dark-card rounded-lg shadow-lg p-4 mb-6 border border-dark-border">
        <div class="flex items-center space-x-4">
          <input type="text" id="new-subreddit" placeholder="Add subreddit (e.g., SomebodyMakeThis)" 
            class="flex-1 px-3 py-2 bg-dark-bg border border-dark-border rounded-md text-white placeholder-dark-muted focus:outline-none focus:ring-2 focus:ring-blue-500">
          <button onclick="addSubreddit()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add</button>
        </div>
      </div>
      <div id="subreddits-container" class="space-y-2">
        <p class="text-dark-muted text-center py-8">Loading subreddits...</p>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 1;
    const pageSize = 50;
    let expandedPostId = null;

    // Debounce function for auto-filter
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Reset all filters
    function resetFilters() {
      document.getElementById('filter-search').value = '';
      document.getElementById('filter-subreddit').value = '';
      document.getElementById('filter-min-upvotes').value = 0;
      document.getElementById('min-upvotes-value').textContent = '0';
      document.getElementById('filter-min-triage').value = 0;
      document.getElementById('min-triage-value').textContent = '0';
      document.getElementById('filter-min-total').value = 0;
      document.getElementById('min-total-value').textContent = '0';
      document.getElementById('filter-min-market').value = 0;
      document.getElementById('min-market-value').textContent = '0';
      document.getElementById('filter-min-wtp').value = 0;
      document.getElementById('min-wtp-value').textContent = '0';
      document.getElementById('filter-min-ease').value = 0;
      document.getElementById('min-ease-value').textContent = '0';
      document.getElementById('filter-min-comp').value = 0;
      document.getElementById('min-comp-value').textContent = '0';
      document.getElementById('filter-bookmarked').checked = false;
      document.getElementById('filter-passed').checked = false;
      document.getElementById('filter-evaluated').checked = false;
      currentPage = 1;
      loadPosts();
    }

    // View switching
    function showView(view) {
      document.getElementById('view-posts').classList.toggle('hidden', view !== 'posts');
      document.getElementById('view-niches').classList.toggle('hidden', view !== 'niches');
      document.getElementById('view-subreddits').classList.toggle('hidden', view !== 'subreddits');
      
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('text-blue-400', 'border-b-2', 'border-blue-400');
        btn.classList.add('text-dark-muted');
      });
      
      const activeTab = document.getElementById(`tab-${view}`);
      activeTab.classList.remove('text-dark-muted');
      activeTab.classList.add('text-blue-400', 'border-b-2', 'border-blue-400');
      
      if (view === 'subreddits') loadSubreddits();
      if (view === 'niches') loadNiches();
    }

    // Triage score badge
    function renderTriageBadge(post) {
      if (!post.isTriaged || post.triageScore === null) return '';
      const score = post.triageScore;
      let bg = score >= 7 ? 'bg-green-600' : score >= 4 ? 'bg-yellow-600' : 'bg-gray-600';
      return `<span class="px-2 py-0.5 text-xs font-medium rounded ${bg} text-white">${score}/10</span>`;
    }

    // Evaluation badge
    function renderEvalBadge(post) {
      if (post.totalScore === null) return '';
      return `<span class="px-2 py-0.5 text-xs font-medium rounded bg-purple-600 text-white">Eval: ${post.totalScore}/40</span>`;
    }

    // Load triage status
    async function loadTriageStatus() {
      try {
        const res = await fetch('/api/filter/status');
        const data = await res.json();
        const statusEl = document.getElementById('filter-status');
        const triageBtn = document.getElementById('triage-btn');
        const stopBtn = document.getElementById('stop-triage-btn');
        
        if (data.isConfigured) {
          const indicator = data.isRunning || data.isBackgroundRunning 
            ? '<span class="inline-block w-2 h-2 rounded-full bg-yellow-500 animate-pulse mr-2"></span>'
            : '<span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span>';
          statusEl.innerHTML = `${indicator}${data.triaged}/${data.total} triaged Â· ${data.passed} passed${data.pending > 0 ? ` Â· <span class="text-orange-400">${data.pending} pending</span>` : ''}`;
          
          if (data.isRunning) {
            triageBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
          } else {
            triageBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
          }
        } else {
          statusEl.innerHTML = '<span class="text-orange-400">Triage not configured (GEMINI_API_KEY missing)</span>';
          triageBtn.disabled = true;
          triageBtn.classList.add('opacity-50');
        }
      } catch (err) {
        console.error('Failed to load triage status:', err);
      }
    }

    // Trigger triage
    async function triggerTriage() {
      const triageBtn = document.getElementById('triage-btn');
      const stopBtn = document.getElementById('stop-triage-btn');
      triageBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');

      try {
        const res = await fetch('/api/filter', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          alert(`Triage ${data.stopped ? 'stopped' : 'complete'}! Triaged ${data.triaged} posts, ${data.passed} passed.`);
          loadPosts();
        } else {
          alert('Triage failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Failed to trigger triage');
      } finally {
        loadTriageStatus();
      }
    }

    // Stop triage
    async function stopTriage() {
      const stopBtn = document.getElementById('stop-triage-btn');
      stopBtn.disabled = true;
      stopBtn.textContent = 'Stopping...';
      try {
        await fetch('/api/filter/stop', { method: 'POST' });
      } catch (err) {
        alert('Failed to stop triage');
      } finally {
        stopBtn.disabled = false;
        stopBtn.textContent = 'Stop Triage';
      }
    }

    // Toggle post expansion
    function togglePost(postId) {
      expandedPostId = expandedPostId === postId ? null : postId;
      loadPosts();
    }

    // Toggle bookmark
    async function toggleBookmark(postId, e) {
      e.stopPropagation();
      try {
        const post = window.postsCache?.find(p => p.id === postId);
        if (!post) return;
        await fetch(`/api/posts/${postId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isFlagged: !post.isFlagged })
        });
        loadPosts();
      } catch (err) {
        console.error('Failed to toggle bookmark:', err);
      }
    }

    // Time ago
    function timeAgo(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      const intervals = [
        { label: 'y', seconds: 31536000 },
        { label: 'mo', seconds: 2592000 },
        { label: 'd', seconds: 86400 },
        { label: 'h', seconds: 3600 },
        { label: 'm', seconds: 60 },
      ];
      for (const interval of intervals) {
        const count = Math.floor(seconds / interval.seconds);
        if (count >= 1) return `${count}${interval.label} ago`;
      }
      return 'just now';
    }

    // Load posts
    async function loadPosts() {
      const search = document.getElementById('filter-search').value;
      const subreddit = document.getElementById('filter-subreddit').value;
      const minUpvotes = document.getElementById('filter-min-upvotes').value;
      const minTriage = document.getElementById('filter-min-triage').value;
      const bookmarked = document.getElementById('filter-bookmarked').checked;
      const passed = document.getElementById('filter-passed').checked;
      const evaluated = document.getElementById('filter-evaluated').checked;
      
      // Evaluation filters
      const minTotal = document.getElementById('filter-min-total').value;
      const minMarket = document.getElementById('filter-min-market').value;
      const minWtp = document.getElementById('filter-min-wtp').value;
      const minEase = document.getElementById('filter-min-ease').value;
      const minComp = document.getElementById('filter-min-comp').value;

      const params = new URLSearchParams();
      if (search) params.append('search', search);
      if (subreddit) params.append('subreddit', subreddit);
      if (minUpvotes > 0) params.append('minScore', minUpvotes);
      if (minTriage > 0) params.append('minTriageScore', minTriage);
      if (bookmarked) params.append('flagged', 'true');
      if (passed) params.append('passedTriage', 'true');
      if (evaluated) params.append('evaluated', 'true');
      if (minTotal > 0) params.append('minTotalScore', minTotal);
      if (minMarket > 0) params.append('minMarketSize', minMarket);
      if (minWtp > 0) params.append('minWtp', minWtp);
      if (minEase > 0) params.append('minEase', minEase);
      if (minComp > 0) params.append('minCompetition', minComp);
      params.append('limit', pageSize);
      params.append('offset', (currentPage - 1) * pageSize);

      try {
        const res = await fetch(`/api/posts?${params}`);
        const data = await res.json();
        window.postsCache = data.posts;

        const container = document.getElementById('posts-container');
        if (data.posts.length === 0) {
          container.innerHTML = '<p class="text-dark-muted text-center py-8">No posts found</p>';
        } else {
          container.innerHTML = data.posts.map(post => {
            const isExpanded = expandedPostId === post.id;
            const borderColor = post.isFlagged ? 'border-l-4 border-yellow-500' : post.passedTriage ? 'border-l-4 border-green-500' : '';
            
            return `
              <div class="bg-dark-card rounded-lg border border-dark-border ${borderColor} overflow-hidden">
                <div class="p-4 cursor-pointer hover:bg-dark-border/30" onclick="togglePost('${post.id}')">
                  <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 flex-wrap">
                        <h3 class="font-medium text-white hover:text-blue-400">${post.title}</h3>
                        ${renderTriageBadge(post)}
                        ${renderEvalBadge(post)}
                      </div>
                      <div class="text-sm text-dark-muted mt-1">
                        <span class="text-blue-400">r/${post.subreddit}</span> Â· ${post.author} Â· ${timeAgo(post.createdUtc)} Â· ${post.score} pts Â· ${post.numComments} comments
                        Â· <code class="text-xs bg-dark-bg px-1 py-0.5 rounded cursor-pointer hover:text-white" onclick="navigator.clipboard.writeText('${post.id}'); event.stopPropagation();" title="Click to copy ID">${post.id.substring(0, 8)}â€¦</code>
                      </div>
                    </div>
                    <button onclick="toggleBookmark('${post.id}', event)" class="p-2 hover:bg-dark-border rounded ${post.isFlagged ? 'text-yellow-500' : 'text-dark-muted hover:text-yellow-500'}">
                      <svg class="w-5 h-5" fill="${post.isFlagged ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                ${isExpanded ? `
                  <div class="px-4 pb-4 border-t border-dark-border">
                    ${post.body ? `<p class="text-dark-text mt-3 text-sm whitespace-pre-wrap">${post.body.substring(0, 1000)}${post.body.length > 1000 ? '...' : ''}</p>` : ''}
                    
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                      <!-- Triage Info -->
                      <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                        <h4 class="text-sm font-medium text-dark-muted mb-2">Triage (Gemini)</h4>
                        ${post.isTriaged ? `
                          <div class="space-y-1 text-sm">
                            <div class="flex justify-between"><span class="text-dark-muted">Score:</span><span class="text-white">${post.triageScore}/10</span></div>
                            <div class="flex justify-between"><span class="text-dark-muted">Passed:</span><span class="${post.passedTriage ? 'text-green-400' : 'text-red-400'}">${post.passedTriage ? 'Yes' : 'No'}</span></div>
                            ${post.triageReason ? `<p class="text-dark-muted text-xs mt-2 italic">${post.triageReason}</p>` : ''}
                          </div>
                        ` : '<p class="text-dark-muted text-sm">Not triaged yet</p>'}
                      </div>
                      
                      <!-- Evaluation Info -->
                      <div class="bg-dark-bg rounded-lg p-3 border border-dark-border">
                        <h4 class="text-sm font-medium text-dark-muted mb-2">Evaluation (Glitch)</h4>
                        ${post.totalScore !== null ? `
                          <div class="space-y-1 text-sm">
                            <div class="flex justify-between"><span class="text-dark-muted">Market Size:</span><span class="text-white">${post.marketSizeScore}/10</span></div>
                            <div class="flex justify-between"><span class="text-dark-muted">WTP:</span><span class="text-white">${post.wtpScore}/10</span></div>
                            <div class="flex justify-between"><span class="text-dark-muted">Ease:</span><span class="text-white">${post.easeScore}/10</span></div>
                            <div class="flex justify-between"><span class="text-dark-muted">Competition:</span><span class="text-white">${post.competitionScore}/10</span></div>
                            <div class="flex justify-between font-medium"><span class="text-dark-muted">Total:</span><span class="text-purple-400">${post.totalScore}/40</span></div>
                            ${post.evaluationNotes ? `<p class="text-dark-muted text-xs mt-2 italic">${post.evaluationNotes}</p>` : ''}
                          </div>
                        ` : '<p class="text-dark-muted text-sm">Not evaluated yet</p>'}
                      </div>
                    </div>
                    
                    <div class="mt-4 flex justify-end">
                      <a href="${post.url}" target="_blank" rel="noopener" class="text-sm text-blue-400 hover:text-blue-300 flex items-center gap-1">
                        View on Reddit
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                      </a>
                    </div>
                  </div>
                ` : ''}
              </div>
            `;
          }).join('');
        }

        // Pagination
        const totalPages = Math.ceil(data.total / pageSize);
        const pagination = document.getElementById('pagination');
        const pageInfo = document.getElementById('page-info');
        
        if (totalPages > 1) {
          pagination.classList.remove('hidden');
          pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
          document.getElementById('prev-btn').disabled = currentPage === 1;
          document.getElementById('next-btn').disabled = currentPage === totalPages;
        } else {
          pagination.classList.add('hidden');
        }
      } catch (err) {
        console.error('Error fetching posts:', err);
        document.getElementById('posts-container').innerHTML = '<p class="text-red-400 text-center py-8">Failed to load posts</p>';
      }
    }

    function prevPage() { if (currentPage > 1) { currentPage--; loadPosts(); } }
    function nextPage() { currentPage++; loadPosts(); }

    // Load subreddits
    async function loadSubreddits() {
      try {
        const res = await fetch('/api/subreddits');
        const data = await res.json();

        // Populate filter dropdown
        const select = document.getElementById('filter-subreddit');
        select.innerHTML = '<option value="">All Subreddits</option>' + 
          data.map(s => `<option value="${s.name}">${s.name}</option>`).join('');

        // Render list
        const container = document.getElementById('subreddits-container');
        container.innerHTML = data.map(s => `
          <div class="bg-dark-card rounded-lg border border-dark-border p-4 flex items-center justify-between">
            <div>
              <span class="font-medium text-white">r/${s.name}</span>
              <span class="text-sm text-dark-muted ml-2">${s.postCount || 0} posts</span>
            </div>
            <div class="flex items-center space-x-4">
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" ${s.enabled ? 'checked' : ''} onchange="toggleSubreddit('${s.id}', this.checked)" class="w-4 h-4 rounded">
                <span class="text-sm text-dark-muted">Enabled</span>
              </label>
              <button onclick="deleteSubreddit('${s.id}', '${s.name}')" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Failed to load subreddits:', err);
      }
    }

    async function addSubreddit() {
      const input = document.getElementById('new-subreddit');
      const name = input.value.trim().replace(/^r\//, '');
      if (!name) return;
      try {
        await fetch('/api/subreddits', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        input.value = '';
        loadSubreddits();
      } catch (err) {
        alert('Failed to add subreddit');
      }
    }

    async function toggleSubreddit(id, enabled) {
      try {
        await fetch(`/api/subreddits/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
      } catch (err) {
        alert('Failed to update subreddit');
        loadSubreddits();
      }
    }

    async function deleteSubreddit(id, name) {
      if (!confirm(`Delete r/${name}? This will also delete all posts from this subreddit.`)) return;
      try {
        await fetch(`/api/subreddits/${id}`, { method: 'DELETE' });
        loadSubreddits();
      } catch (err) {
        alert('Failed to delete subreddit');
      }
    }

    async function triggerCollect() {
      const btn = document.getElementById('collect-btn');
      btn.disabled = true;
      btn.textContent = 'Collecting...';
      try {
        const res = await fetch('/api/collect', { method: 'POST' });
        const data = await res.json();
        alert(`Collection complete! Fetched ${data.totalFetched} posts, ${data.totalNew} new.`);
        loadPosts();
      } catch (err) {
        alert('Failed to trigger collection');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Collect Now';
      }
    }

    // === Niches ===
    let nicheCurrentPage = 1;

    function resetNicheFilters() {
      document.getElementById('niche-filter-search').value = '';
      document.getElementById('niche-filter-min-total').value = 0;
      document.getElementById('niche-min-total-value').textContent = '0';
      document.getElementById('niche-filter-min-revenue').value = 0;
      document.getElementById('niche-min-revenue-value').textContent = '0';
      document.getElementById('niche-filter-min-def').value = 0;
      document.getElementById('niche-min-def-value').textContent = '0';
      document.getElementById('niche-filter-evaluated').checked = false;
      nicheCurrentPage = 1;
      loadNiches();
    }

    function scoreBadge(score, max, color) {
      if (score === null || score === undefined) return '<span class="text-dark-muted">â€”</span>';
      return `<span class="px-2 py-0.5 text-xs font-medium rounded bg-${color}-600 text-white">${score}/${max}</span>`;
    }

    async function loadNiches() {
      const search = document.getElementById('niche-filter-search').value;
      const minTotal = document.getElementById('niche-filter-min-total').value;
      const minRevenue = document.getElementById('niche-filter-min-revenue').value;
      const minDef = document.getElementById('niche-filter-min-def').value;
      const evaluated = document.getElementById('niche-filter-evaluated').checked;

      const params = new URLSearchParams();
      if (search) params.append('search', search);
      if (minTotal > 0) params.append('minTotalScore', minTotal);
      if (minRevenue > 0) params.append('minRevenueScore', minRevenue);
      if (minDef > 0) params.append('minDefensibility', minDef);
      if (evaluated) params.append('evaluated', 'true');
      params.append('limit', pageSize);
      params.append('offset', (nicheCurrentPage - 1) * pageSize);

      try {
        const res = await fetch(`/api/niches?${params}`);
        const data = await res.json();

        const tbody = document.getElementById('niches-table-body');
        if (data.niches.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-dark-muted">No niches found</td></tr>';
        } else {
          tbody.innerHTML = data.niches.map(n => `
            <tr class="border-b border-dark-border hover:bg-dark-border/30">
              <td class="px-4 py-3">
                <div class="font-medium text-white">${n.title}</div>
                ${n.nicheDescription && n.nicheDescription !== n.title ? `<div class="text-xs text-dark-muted mt-1">${n.nicheDescription.substring(0, 150)}${n.nicheDescription.length > 150 ? '...' : ''}</div>` : ''}
              </td>
              <td class="px-4 py-3">
                ${n.parentPost ? `<a href="${n.parentPost.url}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">${n.parentPost.title.substring(0, 60)}${n.parentPost.title.length > 60 ? '...' : ''}</a>` : '<span class="text-dark-muted">â€”</span>'}
              </td>
              <td class="px-4 py-3 text-center">${scoreBadge(n.revenueScore, 10, 'green')}</td>
              <td class="px-4 py-3 text-center">${scoreBadge(n.nicheDefensibility, 10, 'blue')}</td>
              <td class="px-4 py-3 text-center">${scoreBadge(n.totalScore, 40, 'purple')}</td>
              <td class="px-4 py-3"><span class="text-xs px-2 py-1 rounded bg-dark-bg text-dark-muted">${n.nicheSource || 'â€”'}</span></td>
            </tr>
          `).join('');
        }

        // Pagination
        const totalPages = Math.ceil(data.total / pageSize);
        const pagination = document.getElementById('niche-pagination');
        if (totalPages > 1) {
          pagination.classList.remove('hidden');
          document.getElementById('niche-page-info').textContent = `Page ${nicheCurrentPage} of ${totalPages}`;
          document.getElementById('niche-prev-btn').disabled = nicheCurrentPage === 1;
          document.getElementById('niche-next-btn').disabled = nicheCurrentPage === totalPages;
        } else {
          pagination.classList.add('hidden');
        }
      } catch (err) {
        console.error('Error fetching niches:', err);
        document.getElementById('niches-table-body').innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-400">Failed to load niches</td></tr>';
      }
    }

    function prevNichePage() { if (nicheCurrentPage > 1) { nicheCurrentPage--; loadNiches(); } }
    function nextNichePage() { nicheCurrentPage++; loadNiches(); }

    // Auto-filter on change
    const debouncedLoadPosts = debounce(() => { currentPage = 1; loadPosts(); }, 300);

    document.getElementById('filter-search').addEventListener('input', debouncedLoadPosts);
    document.getElementById('filter-subreddit').addEventListener('change', debouncedLoadPosts);
    document.getElementById('filter-min-upvotes').addEventListener('input', (e) => {
      document.getElementById('min-upvotes-value').textContent = e.target.value;
      debouncedLoadPosts();
    });
    document.getElementById('filter-min-triage').addEventListener('input', (e) => {
      document.getElementById('min-triage-value').textContent = e.target.value;
      debouncedLoadPosts();
    });
    document.getElementById('filter-min-total').addEventListener('input', (e) => {
      document.getElementById('min-total-value').textContent = e.target.value;
      debouncedLoadPosts();
    });
    document.getElementById('filter-min-market').addEventListener('input', (e) => {
      document.getElementById('min-market-value').textContent = e.target.value;
      debouncedLoadPosts();
    });
    document.getElementById('filter-min-wtp').addEventListener('input', (e) => {
      document.getElementById('min-wtp-value').textContent = e.target.value;
      debouncedLoadPosts();
    });
    document.getElementById('filter-min-ease').addEventListener('input', (e) => {
      document.getElementById('min-ease-value').textContent = e.target.value;
      debouncedLoadPosts();
    });
    document.getElementById('filter-min-comp').addEventListener('input', (e) => {
      document.getElementById('min-comp-value').textContent = e.target.value;
      debouncedLoadPosts();
    });
    document.getElementById('filter-bookmarked').addEventListener('change', debouncedLoadPosts);
    document.getElementById('filter-passed').addEventListener('change', debouncedLoadPosts);
    document.getElementById('filter-evaluated').addEventListener('change', debouncedLoadPosts);
    document.getElementById('new-subreddit').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addSubreddit();
    });

    // Niche filter listeners
    const debouncedLoadNiches = debounce(() => { nicheCurrentPage = 1; loadNiches(); }, 300);
    document.getElementById('niche-filter-search').addEventListener('input', debouncedLoadNiches);
    document.getElementById('niche-filter-min-total').addEventListener('input', (e) => {
      document.getElementById('niche-min-total-value').textContent = e.target.value;
      debouncedLoadNiches();
    });
    document.getElementById('niche-filter-min-revenue').addEventListener('input', (e) => {
      document.getElementById('niche-min-revenue-value').textContent = e.target.value;
      debouncedLoadNiches();
    });
    document.getElementById('niche-filter-min-def').addEventListener('input', (e) => {
      document.getElementById('niche-min-def-value').textContent = e.target.value;
      debouncedLoadNiches();
    });
    document.getElementById('niche-filter-evaluated').addEventListener('change', debouncedLoadNiches);

    // Initial load
    loadPosts();
    loadSubreddits();
    loadTriageStatus();
    setInterval(loadTriageStatus, 5000);
  </script>
</body>
</html>
